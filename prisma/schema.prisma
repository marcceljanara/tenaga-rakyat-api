// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())
  full_name String @db.VarChar(255)
  phone_number String @unique @db.VarChar(20)
  email String @unique @db.VarChar(255)
  password String @db.VarChar(255)
  role_id Int
  refreshTokens RefreshToken[]
  user_photos UserPhotos[]
  wallets Wallet?
  providedJobs Job[] @relation("ProvidedJobs")
  workedJobs   Job[] @relation("WorkedJobs")
  workerEscrow Escrow[] @relation("WorkerEscrow")
  providerEscrow Escrow[] @relation("ProviderEscrow")
  jobApplications JobApplication[]
  withdrawMethods WithdrawMethod[]
  withdrawRequests WithdrawRequest[]
  emailVerifications EmailVerification[]
  withdrawLockedByAdmin WithdrawRequest[] @relation("LockedBy")
  withdrawApprovedByAdmin WithdrawRequest[] @relation("ApprovedBy")
  withdrawRejectedByAdmin WithdrawRequest[] @relation("RejectedBy")
  profile_picture_url String? @db.VarChar(255)
  about String? @db.Text
  cv_url String? @db.VarChar(512)
  verification_status VerificationStatus @default(UNVERIFIED)
  ktp_number_encrypted String? @db.VarChar(255)
  average_rating Decimal? @db.Decimal(2,1)
  is_deleted Boolean @default(false)
  is_suspended Boolean @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime? @db.Timestamptz()
  suspended_at DateTime? @db.Timestamptz()

  role Role @relation(fields: [role_id], references: [id], onDelete: Restrict, onUpdate: Cascade)
  @@index([role_id])
  @@map("users")

}

enum VerificationType {
  EMAIL
}

enum VerificationPurpose {
  REGISTER
  CHANGE_EMAIL
  RESET_PASSWORD
}

model EmailVerification {
  id String @id @default(uuid())
  user_id String
  email String @db.VarChar(255)
  token_hash String @db.VarChar(255)
  purpose VerificationPurpose
  expires_at DateTime
  verified_at DateTime?
  is_revoked Boolean @default(false)
  created_at DateTime @default(now())
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([email])
  @@index([token_hash])
  @@map("email_verifications")
}


model UserPhotos {
  id Int @id @default(autoincrement())
  user_id String
  user User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  photo_url String @db.VarChar(512)
  description String @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("user_photos")
  @@index([user_id])

}

enum VerificationStatus {
  UNVERIFIED
  EMAIL_VERIFIED
  FULL_VERIFIED
}

model Role {
  id Int @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  users User[]

  @@map("roles")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique @db.VarChar(255)
  user_id     String
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expires_at  DateTime
  created_at  DateTime @default(now())

  @@map("refresh_tokens")
}

model Job {
  id Int @id @default(autoincrement())
  provider_id String 
  worker_id String?
  provider User @relation("ProvidedJobs", fields: [provider_id], references: [id], onDelete: Cascade)
  worker User? @relation("WorkedJobs", fields: [worker_id], references: [id], onDelete: SetNull)
  jobTransactions Transaction[]
  jobApplications JobApplication[]
  jobEscrow Escrow?
  title String @db.VarChar(255)
  description String @db.Text
  location String? @db.VarChar(255)
  compensation_amount Decimal @db.Decimal(12, 2)
  status JobStatus @default(OPEN)
  rejection_count Int @default(0)
  posted_at DateTime @default(now())
  updated_at DateTime @updatedAt
  completed_at DateTime? @db.Timestamptz()

  @@map("jobs")
  @@index([provider_id, worker_id])
}

enum JobStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
  CANCELLED
}

model JobApplication {
  id Int @id @default(autoincrement())
  job_id Int
  job Job @relation(fields: [job_id], references: [id])
  worker_id String
  worker User @relation(fields: [worker_id], references: [id], onDelete: Cascade)
  cover_letter String @db.Text
  status ApplicationStatus @default(PENDING)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("job_applications")
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  ACCEPTED
  REJECTED
}

model Wallet {
  id Int @id @default(autoincrement())
  user_id String @unique
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  balance Decimal @db.Decimal(12, 2) @default(0.00)
  sourceTransactions Transaction[] @relation("SourceWallet")
  destinationTransactions Transaction[] @relation("DestinationWallet")
  status WalletStatus @default(ACTIVE)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("wallets")
}

model Transaction {
  id Int @id @default(autoincrement())
  source_wallet_id Int?
  destination_wallet_id Int?
  job_id Int? @unique
  source_wallet Wallet? @relation("SourceWallet", fields: [source_wallet_id], references: [id], onDelete: SetNull)
  destination_wallet Wallet? @relation("DestinationWallet", fields: [destination_wallet_id], references: [id], onDelete: SetNull)
  job Job? @relation(fields: [job_id], references: [id], onDelete: SetNull)
  amount Decimal @db.Decimal(12, 2)
  transaction_type TransactionType?
  status TransactonStatus @default(PENDING)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("transactions")
  @@index([source_wallet_id, destination_wallet_id])
}

enum WalletStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

enum TransactionType {
  FUNDING
  WITHDRAWAL
  ESCROW_RELEASE
}

enum TransactonStatus {
  PENDING
  COMPLETED
  FAILED
}

model Escrow {
  id Int @id @default(autoincrement())
  job_id Int @unique
  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)
  provider_id String 
  worker_id String
  provider User @relation("ProviderEscrow", fields: [provider_id], references: [id], onDelete: Cascade)
  worker User @relation("WorkerEscrow", fields: [worker_id], references: [id], onDelete: Cascade)
  amount Decimal @db.Decimal(12, 2)
  status EscrowStatus @default(HELD)
  created_at DateTime @default(now())
  released_at DateTime? @db.Timestamptz()
  refunded_at DateTime? @db.Timestamptz()

  @@map("escrows")
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

model PlatformWallet {
  id Int @id @default(autoincrement())
  balance Decimal @db.Decimal(15,2) @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("platform_wallet")
}

model PlatformTransaction {
  id Int @id @default(autoincrement())
  amount Decimal @db.Decimal(15, 2)
  type PlatformTransactionType
  reference_id Int?
  description String @db.VarChar(255)
  created_at DateTime @default(now())

  @@map("platform_transactions")
}

enum PlatformTransactionType {
  ESCROW_FEE
  WITHDRAW_FEE
  SERVICE_FEE
}

model Fee {
  id Int @id @default(autoincrement())
  name String @unique @db.VarChar(50)
  value Decimal @db.Decimal(7, 2)
  fee_type FeeType
  active Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("fees")
}

enum FeeType {
  PERCENTAGE
  FIXED
}

model WithdrawMethod {
  id Int @id @default(autoincrement())
  user_id String 
  user User @relation(fields: [user_id], references: [id], onDelete: Restrict)
  method WithdrawType
  withdrawRequests WithdrawRequest[]
  provider String @db.VarChar(50)
  account_name String @db.VarChar(100)
  account_number String @db.VarChar(255)
  is_active Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("withdraw_methods")
}

enum WithdrawType {
  BANK_TRANSFER
  EWALLET
}

model WithdrawRequest {
  id Int @id @default(autoincrement())
  amount Decimal @db.Decimal(15, 2)
  // fee snapshot
  fee_value Decimal @db.Decimal(15,2) // nilai fee final
  fee_type FeeType // FIXED / PERCENTAGE
  fee_charged Decimal @db.Decimal(15,2) // hasil final fee
  user_id String 
  user User @relation(fields: [user_id], references: [id], onDelete: Restrict)
  method_id Int
  method WithdrawMethod @relation(fields: [method_id], references: [id], onDelete: Restrict)
  status WithdrawStatus @default(PENDING)
  admin_locked_by String?
  lockedByAdmin    User?          @relation("LockedBy", fields: [admin_locked_by], references: [id])
  admin_approved_by String?
  approvedByAdmin  User?          @relation("ApprovedBy", fields: [admin_approved_by], references: [id])
  admin_rejected_by String?
  rejectedByAdmin  User?          @relation("RejectedBy", fields: [admin_rejected_by], references: [id])

  admin_note String? @db.VarChar(255)
  transfer_receipt String? // URL bukti transfer
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("withdraw_requests")
}

enum WithdrawStatus {
  PENDING
  PROCESSING    // sedang dikerjakan admin (LOCK)
  APPROVED
  REJECTED
  SENT  // dana sudah benar-benar dikirim
}