// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())
  full_name String @db.VarChar(255)
  phone_number String @unique @db.VarChar(20)
  email String @unique @db.VarChar(255)
  password String @db.VarChar(255)
  role_id BigInt
  refreshTokens RefreshToken[]
  user_photos UserPhotos[]
  wallets Wallet?
  providedJobs Job[] @relation("ProvidedJobs")
  workedJobs   Job[] @relation("WorkedJobs")
  workerEscrow Escrow[] @relation("WorkerEscrow")
  providerEscrow Escrow[] @relation("ProviderEscrow")
  jobApplications JobApplication[]
  profile_picture_url String? @db.VarChar(255)
  about String? @db.Text
  cv_url String? @db.VarChar(512)
  verification_status VerificationStatus @default(UNVERIFIED)
  ktp_number_encrypted String? @db.VarChar(255)
  average_rating Decimal? @db.Decimal(2,1)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  role Role @relation(fields: [role_id], references: [id], onDelete: Restrict, onUpdate: Cascade)
  @@index([role_id])
  @@map("users")

}

model UserPhotos {
  id BigInt @id @default(autoincrement())
  user_id String
  user User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  photo_url String @db.VarChar(512)
  description String @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("user_photos")
  @@index([user_id])

}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

model Role {
  id BigInt @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  users User[]

  @@map("roles")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique @db.VarChar(255)
  user_id     String
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expires_at  DateTime
  created_at  DateTime @default(now())

  @@map("refresh_tokens")
}

model Job {
  id BigInt @id @default(autoincrement())
  provider_id String 
  worker_id String?
  provider User @relation("ProvidedJobs", fields: [provider_id], references: [id], onDelete: Cascade)
  worker User? @relation("WorkedJobs", fields: [worker_id], references: [id], onDelete: SetNull)
  jobTransactions Transaction[]
  jobApplications JobApplication[]
  jobEscrow Escrow?
  title String @db.VarChar(255)
  description String @db.Text
  location String? @db.VarChar(255)
  compensation_amount Decimal @db.Decimal(12, 2)
  status JobStatus @default(OPEN)
  rejection_count Int @default(0)
  posted_at DateTime @default(now())
  updated_at DateTime @updatedAt
  completed_at DateTime? @db.Timestamptz()

  @@map("jobs")
  @@index([provider_id, worker_id])
}

enum JobStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
  CANCELLED
}

model JobApplication {
  id BigInt @id @default(autoincrement())
  job_id BigInt
  job Job @relation(fields: [job_id], references: [id])
  worker_id String
  worker User @relation(fields: [worker_id], references: [id], onDelete: Cascade)
  cover_letter String @db.Text
  status ApplicationStatus @default(PENDING)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("job_applications")
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  ACCEPTED
  REJECTED
}

model Wallet {
  id BigInt @id @default(autoincrement())
  user_id String @unique
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  balance Decimal @db.Decimal(12, 2) @default(0.00)
  sourceTransactions Transaction[] @relation("SourceWallet")
  destinationTransactions Transaction[] @relation("DestinationWallet")
  status WalletStatus @default(ACTIVE)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("wallets")
}

model Transaction {
  id BigInt @id @default(autoincrement())
  source_wallet_id BigInt?
  destination_wallet_id BigInt?
  job_id BigInt? @unique
  source_wallet Wallet? @relation("SourceWallet", fields: [source_wallet_id], references: [id], onDelete: SetNull)
  destination_wallet Wallet? @relation("DestinationWallet", fields: [destination_wallet_id], references: [id], onDelete: SetNull)
  job Job? @relation(fields: [job_id], references: [id], onDelete: SetNull)
  amount Decimal @db.Decimal(12, 2)
  transaction_type TransactionType?
  status TransactonStatus @default(PENDING)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("transactions")
  @@index([source_wallet_id, destination_wallet_id])
}

enum WalletStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

enum TransactionType {
  FUNDING
  WITHDRAWAL
  ESCROW_RELEASE
}

enum TransactonStatus {
  PENDING
  COMPLETED
  FAILED
}

model Escrow {
  id BigInt @id @default(autoincrement())
  job_id BigInt @unique
  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)
  provider_id String 
  worker_id String
  provider User @relation("ProviderEscrow", fields: [provider_id], references: [id], onDelete: Cascade)
  worker User @relation("WorkerEscrow", fields: [worker_id], references: [id], onDelete: Cascade)
  amount Decimal @db.Decimal(12, 2)
  status EscrowStatus @default(HELD)
  created_at DateTime @default(now())
  released_at DateTime? @db.Timestamptz()
  refunded_at DateTime? @db.Timestamptz()

  @@map("escrows")
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

model PlatformWallet {
  id BigInt @id @default(autoincrement())
  balance Decimal @db.Decimal(15,2) @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("platform_wallet")
}

model PlatformTransaction {
  id BigInt @id @default(autoincrement())
  amount Decimal @db.Decimal(15, 2)
  type PlatformTransactionType
  reference_id BigInt?
  description String @db.VarChar(255)
  created_at DateTime @default(now())

  @@map("platform_transactions")
}

enum PlatformTransactionType {
  ESCROW_FEE
  WITHDRAW_FEE
  SERVICE_FEE
}